# Prepare
mkdir -p /etc/docker-gitlab
curl -sSL https://raw.githubusercontent.com/hydra1983/docker-gitlab-helper/master/etc/docker-gitlab/gitlab.conf > /etc/docker-gitlab/gitlab.conf


# Prepare ENV
curl -sSL https://get.docker.io/ubuntu/ | sh
apt-get install -y --force-yes sshpass mysql-client-core-5.5 curl

mkdir -p /opt/mysql/data
mkdir -p /opt/gitlab/data

# Initialise MySQL
source /etc/docker-gitlab/gitlab.conf
docker run --name=mysql -d -p 3306:3306 -e "DB_USER=${MYSQL_USERNAME}" -e "DB_PASS=${MYSQL_PASSWORD}" -e "DB_NAME=${MYSQL_DATABASE}" -v /opt/mysql/data:/var/lib/mysql sameersbn/mysql:latest
mysql_ssh_host=`docker inspect mysql | grep IPAddres | awk -F'"' '{print $4}'`
docker run --name=gitlab -i -t --rm --link mysql:mysql -e "DB_USER=${MYSQL_USERNAME}" -e "DB_PASS=${MYSQL_PASSWORD}" -e "DB_NAME=${MYSQL_DATABASE}" -v /opt/gitlab/data:/home/git/data sameersbn/gitlab:${CURRENT_VERSION} app:rake gitlab:setup
docker stop mysql
docker rm mysql

# Start Gitlab
curl -sSL https://github.com/hydra1983/docker-gitlab-helper/raw/master/etc/init.d/docker-gitlab > /etc/init.d/docker-gitlab
chmod +x /etc/init.d/docker-gitlab
/etc/init.d/docker-gitlab start
update-rc.d docker-gitlab defaults